<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Alpha Scanner</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --buy: #238636;
            --buy-text: #3fb950;
            --hold: #1f6feb;
            --hold-text: #58a6ff;
            --avoid: #da3633;
            --avoid-text: #f85149;
            --link-color: #58a6ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 2.5rem;
            margin-top: 1rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--link-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Stock cards */
        .pick-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .pick-card:hover {
            border-color: var(--text-secondary);
        }

        .pick-card.buy {
            border-left: 4px solid var(--buy);
        }

        .pick-card.hold {
            border-left: 4px solid var(--hold);
        }

        .pick-card.avoid {
            border-left: 4px solid var(--avoid);
        }

        .pick-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .signal-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-badge.buy {
            background: rgba(35, 134, 54, 0.2);
            color: var(--buy-text);
        }

        .signal-badge.hold {
            background: rgba(31, 111, 235, 0.2);
            color: var(--hold-text);
        }

        .signal-badge.avoid {
            background: rgba(218, 54, 51, 0.2);
            color: var(--avoid-text);
        }

        .alpha-score {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .sector-tag {
            padding: 0.15rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .stock-title {
            font-size: 1.15rem;
            margin-bottom: 0.5rem;
        }

        .stock-title .ticker {
            font-weight: 700;
            color: var(--text-primary);
        }

        .stock-title .name {
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .metric-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .positive { color: var(--buy-text); }
        .negative { color: var(--avoid-text); }
        .neutral { color: var(--text-primary); }

        /* Score breakdown bar */
        .score-bar {
            display: flex;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
            background: var(--bg-tertiary);
        }

        .score-segment {
            height: 100%;
            transition: width 0.3s;
        }

        .score-segment.value { background: #f0883e; }
        .score-segment.quality { background: #a371f7; }
        .score-segment.momentum { background: #3fb950; }
        .score-segment.catalyst { background: #58a6ff; }
        .score-segment.liquidity { background: #d29922; }

        .score-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .score-legend span::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            margin-right: 4px;
            vertical-align: middle;
        }

        .score-legend .l-value::before { background: #f0883e; }
        .score-legend .l-quality::before { background: #a371f7; }
        .score-legend .l-momentum::before { background: #3fb950; }
        .score-legend .l-catalyst::before { background: #58a6ff; }
        .score-legend .l-liquidity::before { background: #d29922; }

        /* Reasoning */
        .reasoning {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.95rem;
        }

        /* Expandable details */
        details {
            margin-bottom: 0.75rem;
        }

        summary {
            cursor: pointer;
            color: var(--link-color);
            font-size: 0.9rem;
        }

        summary:hover {
            text-decoration: underline;
        }

        .detail-content {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .detail-content h4 {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .detail-content ul {
            list-style: none;
            margin-bottom: 1rem;
        }

        .detail-content li {
            padding: 0.25rem 0;
            font-size: 0.9rem;
            padding-left: 1rem;
            position: relative;
        }

        .detail-content li::before {
            content: "\2022";
            position: absolute;
            left: 0;
            color: var(--text-secondary);
        }

        .detail-content a {
            color: var(--link-color);
            text-decoration: none;
            word-break: break-all;
        }

        .detail-content a:hover {
            text-decoration: underline;
        }

        /* Card footer */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .yahoo-link {
            color: var(--link-color);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .yahoo-link:hover {
            text-decoration: underline;
        }

        .timeframe-badge {
            padding: 0.15rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Empty state */
        .no-picks {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        /* Footer */
        footer {
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        footer a {
            color: var(--link-color);
            text-decoration: none;
        }

        .disclaimer {
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Info tooltips */
        .info-tip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.55rem;
            font-weight: 700;
            font-style: normal;
            cursor: help;
            vertical-align: middle;
            margin-left: 4px;
            flex-shrink: 0;
        }

        .info-tip:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .info-tip .tip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.75rem;
            font-weight: 400;
            line-height: 1.4;
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            width: 240px;
            z-index: 100;
            transition: opacity 0.15s, visibility 0.15s;
            pointer-events: none;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .info-tip .tip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border-color);
        }

        .info-tip:hover .tip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Flip tooltip down when near top */
        .info-tip.tip-down .tip-text {
            bottom: auto;
            top: calc(100% + 8px);
        }

        .info-tip.tip-down .tip-text::after {
            top: auto;
            bottom: 100%;
            border-top-color: transparent;
            border-bottom-color: var(--border-color);
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .stats {
                gap: 1rem;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Stock Alpha Scanner</h1>
            <p class="meta">
                Last updated: {{ run_date[:19].replace('T', ' ') }} UTC
            </p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value">{{ stocks_scanned }}</div>
                    <div class="stat-label">Stocks Scanned</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{{ picks|length }}</div>
                    <div class="stat-label">Alpha Picks</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{{ avg_score }}</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            </div>
        </header>

        <main>
            {% if picks %}
                {% for pick in picks %}
                {% set signal_class = pick.signal|lower %}
                <div class="pick-card {{ signal_class }}">
                    <div class="pick-header">
                        <div class="header-left">
                            <span class="signal-badge {{ signal_class }}">{{ pick.signal }}</span>
                            <span class="info-tip tip-down">i<span class="tip-text">{% if pick.signal == 'BUY' %}BUY: AI research is bullish with high confidence and the stock scores well on fundamentals, momentum, and quality.{% elif pick.signal == 'HOLD' %}HOLD: AI research found a neutral outlook, or the bullish case wasn't strong enough to warrant a BUY. The stock may still score well on fundamentals -- worth monitoring.{% else %}AVOID: AI research is bearish with medium-high confidence. Significant risks or negative outlook detected.{% endif %}</span></span>
                            <span class="alpha-score">Score: {{ pick.alpha_score }}<span class="info-tip tip-down">i<span class="tip-text">Alpha Score (0-100): Composite score based on 5 factors -- Value (25pts), Quality (25pts), Momentum (25pts), Catalyst (15pts), and Liquidity (10pts). Higher = stronger opportunity.</span></span></span>
                            {% if pick.sector %}
                            <span class="sector-tag">{{ pick.sector }}</span>
                            {% endif %}
                        </div>
                        <span class="alpha-score">{{ pick.confidence }} confidence<span class="info-tip tip-down">i<span class="tip-text">{% if pick.confidence == 'HIGH' %}HIGH: AI research is very certain about its assessment. Note: high confidence in a NEUTRAL outlook still results in HOLD.{% elif pick.confidence == 'MEDIUM' %}MEDIUM: AI research found supporting evidence but with some uncertainty or conflicting signals.{% else %}LOW: Limited evidence available or significant uncertainty in the outlook.{% endif %}</span></span></span>
                    </div>

                    <h3 class="stock-title">
                        <span class="ticker">{{ pick.ticker }}</span>
                        <span class="name"> &mdash; {{ pick.name }}</span>
                    </h3>

                    <!-- Metrics grid -->
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-value neutral">{{ "%.1f"|format(pick.pe_ratio) if pick.pe_ratio else 'N/A' }}</div>
                            <div class="metric-label">P/E <span class="info-tip">i<span class="tip-text">Price-to-Earnings ratio. Compares stock price to earnings per share. Lower = cheaper relative to profits. Compare within the same sector.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.roe and pick.roe > 15 %}positive{% elif pick.roe and pick.roe < 5 %}negative{% else %}neutral{% endif %}">
                                {{ "%.1f%%"|format(pick.roe) if pick.roe else 'N/A' }}
                            </div>
                            <div class="metric-label">ROE <span class="info-tip">i<span class="tip-text">Return on Equity. How efficiently the company generates profit from shareholder money. Above 15% is strong, above 20% is excellent.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.dividend_yield and pick.dividend_yield > 2 %}positive{% else %}neutral{% endif %}">
                                {{ "%.1f%%"|format(pick.dividend_yield) if pick.dividend_yield else 'N/A' }}
                            </div>
                            <div class="metric-label">Div Yield <span class="info-tip">i<span class="tip-text">Annual dividend as % of stock price. Above 2% is solid, above 3% is high yield. 0% means the company doesn't pay dividends.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.momentum_6m and pick.momentum_6m > 0 %}positive{% elif pick.momentum_6m and pick.momentum_6m < 0 %}negative{% else %}neutral{% endif %}">
                                {{ "%+.1f%%"|format(pick.momentum_6m) if pick.momentum_6m else 'N/A' }}
                            </div>
                            <div class="metric-label">6m <span class="info-tip">i<span class="tip-text">Price return over the last 6 months. Green = stock has been rising, red = declining. Shows medium-term trend.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.momentum_12m and pick.momentum_12m > 0 %}positive{% elif pick.momentum_12m and pick.momentum_12m < 0 %}negative{% else %}neutral{% endif %}">
                                {{ "%+.1f%%"|format(pick.momentum_12m) if pick.momentum_12m else 'N/A' }}
                            </div>
                            <div class="metric-label">12m <span class="info-tip">i<span class="tip-text">Price return over the last 12 months. Shows the longer-term trend. Stocks with positive 12m momentum tend to continue performing.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.rsi_14 and pick.rsi_14 > 70 %}negative{% elif pick.rsi_14 and pick.rsi_14 < 30 %}positive{% else %}neutral{% endif %}">
                                {{ "%.0f"|format(pick.rsi_14) if pick.rsi_14 else 'N/A' }}
                            </div>
                            <div class="metric-label">RSI <span class="info-tip">i<span class="tip-text">Relative Strength Index (0-100). Below 30 = oversold (potential bounce), above 70 = overbought (potential pullback), 40-70 = healthy range.</span></span></div>
                        </div>
                    </div>

                    <!-- Score breakdown bar -->
                    {% if pick.score_breakdown %}
                    {% set bd = pick.score_breakdown %}
                    {% set total = pick.alpha_score if pick.alpha_score > 0 else 1 %}
                    <div class="score-bar">
                        <div class="score-segment value" style="width: {{ (bd.get('value', 0) / total * 100)|round }}%"></div>
                        <div class="score-segment quality" style="width: {{ (bd.get('quality', 0) / total * 100)|round }}%"></div>
                        <div class="score-segment momentum" style="width: {{ (bd.get('momentum', 0) / total * 100)|round }}%"></div>
                        <div class="score-segment catalyst" style="width: {{ (bd.get('catalyst', 0) / total * 100)|round }}%"></div>
                        <div class="score-segment liquidity" style="width: {{ (bd.get('liquidity', 0) / total * 100)|round }}%"></div>
                    </div>
                    <div class="score-legend">
                        <span class="l-value">Value {{ bd.get('value', 0) }}/25 <span class="info-tip">i<span class="tip-text">Value: Is the stock cheap? Based on P/E and P/B vs sector median, plus dividend yield.</span></span></span>
                        <span class="l-quality">Quality {{ bd.get('quality', 0) }}/25 <span class="info-tip">i<span class="tip-text">Quality: Is it a good business? Based on ROE, low debt, dividend track record, and earnings growth.</span></span></span>
                        <span class="l-momentum">Momentum {{ bd.get('momentum', 0) }}/25 <span class="info-tip">i<span class="tip-text">Momentum: Is it trending up? Based on 6m/12m returns, price vs moving averages, and RSI health.</span></span></span>
                        <span class="l-catalyst">Catalyst {{ bd.get('catalyst', 0) }}/15 <span class="info-tip">i<span class="tip-text">Catalyst: Are there upcoming events? Scores for earnings dates, priority sectors, and recovery potential from 52-week highs.</span></span></span>
                        <span class="l-liquidity">Liquidity {{ bd.get('liquidity', 0) }}/10 <span class="info-tip">i<span class="tip-text">Liquidity: Can you trade it easily? Based on market cap size, trading volume, and major index membership.</span></span></span>
                    </div>
                    {% endif %}

                    <!-- Reasoning -->
                    {% if pick.reasoning %}
                    <div class="reasoning">{{ pick.reasoning }}</div>
                    {% endif %}

                    <!-- Expandable details -->
                    <details>
                        <summary>Developments, Catalysts & Risks</summary>
                        <div class="detail-content">
                            {% if pick.company_overview %}
                            <h4>Overview</h4>
                            <p style="margin-bottom: 1rem; font-size: 0.9rem;">{{ pick.company_overview }}</p>
                            {% endif %}

                            {% if pick.key_developments %}
                            <h4>Key Developments</h4>
                            <ul>
                                {% for dev in pick.key_developments[:5] %}
                                <li>{{ dev }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if pick.catalysts %}
                            <h4>Catalysts</h4>
                            <ul>
                                {% for cat in pick.catalysts[:4] %}
                                <li>{{ cat }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if pick.risk_factors %}
                            <h4>Risk Factors</h4>
                            <ul>
                                {% for risk in pick.risk_factors[:4] %}
                                <li>{{ risk }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if pick.sources %}
                            <h4>Sources</h4>
                            <ul>
                                {% for src in pick.sources[:5] %}
                                <li><a href="{{ src }}" target="_blank" rel="noopener">{{ src[:70] }}{% if src|length > 70 %}...{% endif %}</a></li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                    </details>

                    <div class="card-footer">
                        {% set yf_symbol = pick.ticker %}
                        {% if pick.exchange == 'AMS' %}{% set yf_symbol = pick.ticker ~ '.AS' %}
                        {% elif pick.exchange == 'XETR' %}{% set yf_symbol = pick.ticker ~ '.DE' %}
                        {% elif pick.exchange == 'EPA' %}{% set yf_symbol = pick.ticker ~ '.PA' %}
                        {% elif pick.exchange == 'LSE' %}{% set yf_symbol = pick.ticker ~ '.L' %}
                        {% endif %}
                        <a href="https://finance.yahoo.com/quote/{{ yf_symbol }}" class="yahoo-link" target="_blank" rel="noopener">
                            View on Yahoo Finance &rarr;
                        </a>
                        <span class="timeframe-badge">{{ pick.target_timeframe if pick.target_timeframe else '3-6 months' }} <span class="info-tip">i<span class="tip-text">Suggested investment horizon. This signal is based on medium-term analysis -- not a day-trading recommendation.</span></span></span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-picks">
                    No high-alpha opportunities found in this scan.
                </div>
            {% endif %}
        </main>

        <footer>
            <p>
                Data from <a href="https://finance.yahoo.com" target="_blank">Yahoo Finance</a>
                & <a href="https://twelvedata.com" target="_blank">Twelve Data</a>
                | Research via <a href="https://perplexity.ai" target="_blank">Perplexity</a>
            </p>
            <p class="disclaimer">
                Signal generation only. Not financial advice. Do your own research.
            </p>
        </footer>
    </div>
</body>
</html>
