<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Alpha Scanner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1f4c8;</text></svg>">
    <meta property="og:title" content="Stock Alpha Scanner">
    <meta property="og:description" content="{{ buy_count }} BUY signal{{ 's' if buy_count != 1 }} this week from {{ stocks_scanned }} stocks scanned across AEX, DAX, CAC40, FTSE100, DJIA &amp; NASDAQ.">
    <meta property="og:type" content="website">
    <meta name="description" content="Weekly AI-powered stock scanner. {{ buy_count }} BUY signals from {{ stocks_scanned }} stocks.">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --card2: #21262d;
            --text: #e6edf3; --dim: #8b949e; --border: #30363d;
            --buy: #238636; --buyT: #3fb950;
            --hold: #1f6feb; --holdT: #58a6ff;
            --avoid: #da3633; --avoidT: #f85149;
            --link: #58a6ff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        .container { max-width: 960px; margin: 0 auto; padding: 2rem; }

        /* Header */
        header { text-align: center; padding-bottom: 2rem; }
        header h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 0.25rem; }
        .meta { color: var(--dim); font-size: 0.8rem; }
        .header-pills { display: flex; justify-content: center; gap: 1.5rem; margin-top: 1rem; }
        .pill { text-align: center; }
        .pill-value { font-size: 1.4rem; font-weight: 700; }
        .pill-label { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.05em; }

        /* Hero */
        .hero { background: linear-gradient(135deg, rgba(35,134,54,0.1), var(--card)); border: 1px solid var(--buy); border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 2rem; }
        .hero-eyebrow { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--buyT); margin-bottom: 0.5rem; }
        .hero-ticker { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.02em; }
        .hero-name { color: var(--dim); font-size: 0.9rem; margin-bottom: 1rem; }
        .hero-row { display: flex; justify-content: center; gap: 2.5rem; flex-wrap: wrap; }
        .hero-num { font-size: 1.1rem; font-weight: 600; }
        .hero-label { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; }

        /* Controls */
        .controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; position: sticky; top: 0; z-index: 50; background: var(--bg); padding: 0.75rem 0; }
        .fbtn { padding: 0.3rem 0.75rem; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--dim); font-size: 0.75rem; font-weight: 600; cursor: pointer; opacity: 0.5; transition: all 0.15s; }
        .fbtn.on { opacity: 1; }
        .fbtn[data-f="all"].on { color: var(--text); border-color: var(--dim); }
        .fbtn.f-buy.on { color: var(--buyT); border-color: var(--buy); }
        .fbtn.f-hold.on { color: var(--holdT); border-color: var(--hold); }
        .fbtn.f-avoid.on { color: var(--avoidT); border-color: var(--avoid); }
        .search { flex: 1; min-width: 80px; max-width: 160px; padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: var(--card2); color: var(--text); font-size: 0.75rem; }
        .search:focus { outline: none; border-color: var(--link); }
        .search::placeholder { color: var(--dim); }
        .sort { padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: var(--card2); color: var(--text); font-size: 0.75rem; margin-left: auto; }

        /* Card grid */
        .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 700px) { .grid { grid-template-columns: repeat(2, 1fr); } }

        /* Cards */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; transition: border-color 0.15s; }
        .card:hover { border-color: var(--dim); }
        .card.buy { border-left: 3px solid var(--buy); }
        .card.hold { border-left: 3px solid var(--hold); }
        .card.avoid { border-left: 3px solid var(--avoid); }

        .card-top { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.5rem; }
        .signal { padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .signal.buy { background: rgba(35,134,54,0.2); color: var(--buyT); }
        .signal.hold { background: rgba(31,111,235,0.2); color: var(--holdT); }
        .signal.avoid { background: rgba(218,54,51,0.2); color: var(--avoidT); }
        .card-score { font-size: 0.8rem; color: var(--dim); margin-left: auto; }
        .card-sector { font-size: 0.7rem; color: var(--dim); background: var(--card2); padding: 0.1rem 0.4rem; border-radius: 3px; }

        .card-ticker { font-size: 1.15rem; font-weight: 700; }
        .card-name { color: var(--dim); font-weight: 400; font-size: 0.9rem; }
        .streak { font-size: 0.6rem; font-weight: 600; background: rgba(210,153,34,0.2); color: #d29922; padding: 0.1rem 0.4rem; border-radius: 8px; margin-left: 0.3rem; vertical-align: middle; }

        /* Price range bar */
        .range-bar { margin: 1rem 0; }
        .range-track { position: relative; height: 4px; background: var(--card2); border-radius: 2px; margin: 0.25rem 0; }
        .range-fill { position: absolute; height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--avoidT), var(--buyT)); }
        .range-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; background: var(--text); top: -3px; transform: translateX(-50%); }
        .range-labels { display: flex; justify-content: space-between; font-size: 0.7rem; }
        .range-stop { color: var(--avoidT); text-align: left; }
        .range-price { color: var(--text); font-weight: 600; }
        .range-target { color: var(--buyT); text-align: right; }
        .range-hint { display: block; font-size: 0.55rem; color: var(--dim); font-weight: 400; letter-spacing: 0.03em; }

        /* Allocation */
        .alloc { display: inline-block; font-size: 0.7rem; font-weight: 600; color: var(--link); background: rgba(88,166,255,0.1); padding: 0.15rem 0.5rem; border-radius: 10px; margin-top: 0.25rem; }

        /* Reasoning - truncated */
        .reasoning { font-size: 0.85rem; color: var(--dim); margin: 0.75rem 0; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .reasoning.expanded { -webkit-line-clamp: unset; }

        .read-more { color: var(--link); font-size: 0.8rem; cursor: pointer; border: none; background: none; padding: 0; }
        .read-more:hover { text-decoration: underline; }

        /* Score bar */
        .score-bar { display: flex; height: 10px; border-radius: 5px; overflow: hidden; background: var(--card2); }
        .score-bar > div { height: 100%; position: relative; }
        .sb-val { background: #f0883e; }
        .sb-qual { background: #a371f7; }
        .sb-mom { background: #3fb950; }
        .sb-cat { background: #58a6ff; }
        .sb-liq { background: #d29922; }
        .score-legend { display: flex; justify-content: space-between; margin-top: 0.3rem; font-size: 0.6rem; color: var(--dim); }
        .score-legend span { display: flex; align-items: center; gap: 0.2rem; }
        .score-legend i { display: inline-block; width: 6px; height: 6px; border-radius: 2px; }

        /* Card details */
        .card details { margin-top: 0.5rem; }
        .card summary { font-size: 0.8rem; color: var(--link); cursor: pointer; }
        .card summary:hover { text-decoration: underline; }
        .detail-body { margin-top: 0.5rem; font-size: 0.85rem; color: var(--dim); }
        .detail-body h4 { font-size: 0.8rem; color: var(--text); margin: 0.75rem 0 0.25rem; }
        .detail-body ul { list-style: none; }
        .detail-body li { padding: 0.2rem 0 0.2rem 0.75rem; position: relative; }
        .detail-body li::before { content: "\2022"; position: absolute; left: 0; color: var(--dim); }
        .detail-body a { color: var(--link); text-decoration: none; word-break: break-all; }

        .card-foot { display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid var(--border); font-size: 0.8rem; }
        .card-foot a { color: var(--link); text-decoration: none; }
        .card-foot a:hover { text-decoration: underline; }
        .tf-badge { color: var(--dim); font-size: 0.7rem; }

        /* Model Performance */
        .perf { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem; }
        .perf-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
        .perf-head h2 { font-size: 1.1rem; }
        .tf-pills { display: flex; gap: 0.3rem; }
        .tf-pill { padding: 0.25rem 0.6rem; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--dim); font-size: 0.7rem; font-weight: 600; cursor: pointer; }
        .tf-pill.on { background: rgba(88,166,255,0.15); color: var(--link); border-color: var(--link); }
        .perf-nums { display: flex; gap: 2rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .perf-n { text-align: center; }
        .perf-nv { font-size: 1.3rem; font-weight: 700; }
        .perf-nl { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; }
        .pos { color: var(--buyT); }
        .neg { color: var(--avoidT); }

        .sig-bar-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem; }
        .sig-bar-label { width: 40px; font-size: 0.8rem; font-weight: 600; }
        .sig-bar-bg { flex: 1; height: 8px; background: var(--card2); border-radius: 4px; overflow: hidden; }
        .sig-bar-fill { height: 100%; border-radius: 4px; }
        .sig-bar-fill.buy { background: var(--buy); }
        .sig-bar-fill.hold { background: var(--hold); }
        .sig-bar-fill.avoid { background: var(--avoid); }
        .sig-bar-pct { font-size: 0.7rem; color: var(--dim); width: 70px; text-align: right; }

        .perf-chart { position: relative; height: 200px; margin: 1rem 0; padding: 0.5rem; background: var(--card2); border-radius: 6px; }
        .chart-empty { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--dim); font-size: 0.85rem; }

        .eval-tbl { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .eval-tbl th { text-align: left; padding: 0.4rem; border-bottom: 1px solid var(--border); color: var(--dim); font-size: 0.7rem; }
        .eval-tbl td { padding: 0.4rem; border-bottom: 1px solid var(--card2); }
        .oc { color: var(--buyT); }
        .oi { color: var(--avoidT); }
        .ou { color: var(--dim); }

        .w-adj { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-right: 0.3rem; }
        .w-adj.pos { background: rgba(35,134,54,0.2); }
        .w-adj.neg { background: rgba(218,54,51,0.2); }
        .w-adj.zero { background: var(--card2); color: var(--dim); }

        /* Explainer */
        .explainer { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem; }
        .explainer h2 { font-size: 1rem; margin-bottom: 0.75rem; }
        .explainer p { font-size: 0.85rem; color: var(--dim); margin-bottom: 0.75rem; line-height: 1.6; }
        .steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin: 1rem 0; }
        .step { text-align: center; padding: 0.75rem; background: var(--card2); border-radius: 8px; }
        .step-icon { font-size: 1.4rem; margin-bottom: 0.25rem; }
        .step-title { font-size: 0.75rem; font-weight: 700; color: var(--text); }
        .step-desc { font-size: 0.65rem; color: var(--dim); margin-top: 0.15rem; }
        .explainer .tg-cta { display: inline-flex; align-items: center; gap: 0.4rem; margin-top: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; background: rgba(0,136,204,0.15); color: #29b6f6; font-size: 0.85rem; font-weight: 600; text-decoration: none; transition: background 0.15s; }
        .explainer .tg-cta:hover { background: rgba(0,136,204,0.25); }

        /* Telegram */
        .tg-link { display: inline-block; margin-top: 0.5rem; padding: 0.35rem 0.9rem; border-radius: 20px; background: rgba(0,136,204,0.12); color: #29b6f6; font-size: 0.8rem; font-weight: 600; text-decoration: none; }
        .tg-link:hover { background: rgba(0,136,204,0.22); }

        /* Footer */
        footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid var(--border); text-align: center; color: var(--dim); font-size: 0.75rem; }
        footer a { color: var(--link); text-decoration: none; }
        .disc { font-style: italic; margin-top: 0.3rem; }

        .empty { text-align: center; padding: 3rem; color: var(--dim); }

        /* Mobile */
        @media (max-width: 600px) {
            .container { padding: 1rem; }
            header h1 { font-size: 1.3rem; }
            .header-pills { gap: 1rem; }
            .pill-value { font-size: 1.1rem; }
            .hero { padding: 1.25rem; }
            .hero-ticker { font-size: 1.6rem; }
            .hero-row { gap: 1.5rem; }
            .controls { position: static; flex-wrap: wrap; }
            .search { max-width: none; flex: 1 1 100%; order: 10; }
            .grid { grid-template-columns: 1fr; }
            .perf-nums { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .perf-chart { height: 160px; }
            .sig-bar-row { flex-wrap: wrap; }
            .sig-bar-pct { width: 100%; text-align: left; padding-left: 40px; font-size: 0.65rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Stock Alpha Scanner</h1>
            <p class="meta">{{ run_date[:19].replace('T', ' ') }} UTC <span id="next-scan"></span></p>
            <div class="header-pills">
                <div class="pill"><div class="pill-value" style="color:var(--buyT)">{{ buy_count }}</div><div class="pill-label">Buy</div></div>
                <div class="pill"><div class="pill-value" style="color:var(--holdT)">{{ hold_count }}</div><div class="pill-label">Hold</div></div>
                <div class="pill"><div class="pill-value" style="color:var(--avoidT)">{{ avoid_count }}</div><div class="pill-label">Avoid</div></div>
                <div class="pill"><div class="pill-value">{{ avg_score }}</div><div class="pill-label">Avg Score</div></div>
            </div>
        </header>

        {# Hero: top BUY pick #}
        {% if picks %}
        {% set top_buy = picks | selectattr('signal', 'equalto', 'BUY') | list | first %}
        {% if top_buy %}
        <div class="hero">
            <div class="hero-eyebrow">Top Pick</div>
            <div class="hero-ticker">{{ top_buy.ticker }}</div>
            <div class="hero-name">{{ top_buy.name }}</div>
            <div class="hero-row">
                <div><div class="hero-num">{{ top_buy.price }} {{ top_buy.currency }}</div><div class="hero-label">Price</div></div>
                <div><div class="hero-num pos">{{ top_buy.alpha_score }}</div><div class="hero-label">Score</div></div>
                {% if top_buy.stop_loss %}<div><div class="hero-num neg">{{ "%.2f"|format(top_buy.stop_loss) }}</div><div class="hero-label">Stop</div></div>{% endif %}
                {% if top_buy.take_profit %}<div><div class="hero-num pos">{{ "%.2f"|format(top_buy.take_profit) }}</div><div class="hero-label">Target</div></div>{% endif %}
            </div>
            <a href="https://t.me/StockScanner1234567890bot" class="tg-link" style="margin-top:1rem;">Get alerts on Telegram</a>
        </div>
        {% endif %}
        {% endif %}

        {# Explainer #}
        <section class="explainer">
            <h2>How does this work?</h2>
            <p>Every Monday before markets open, this scanner analyzes <strong>{{ stocks_scanned }}+ stocks</strong> across 6 major indices (AEX, DAX, CAC40, FTSE100, DJIA, NASDAQ) and scores each on 5 factors.</p>
            <div class="steps">
                <div class="step"><div class="step-icon">1</div><div class="step-title">Scan</div><div class="step-desc">250 stocks from 6 indices</div></div>
                <div class="step"><div class="step-icon">2</div><div class="step-title">Score</div><div class="step-desc">Value, Quality, Momentum, Catalyst, Liquidity</div></div>
                <div class="step"><div class="step-icon">3</div><div class="step-title">Research</div><div class="step-desc">AI reads latest news &amp; filings</div></div>
                <div class="step"><div class="step-icon">4</div><div class="step-title">Signal</div><div class="step-desc">BUY, HOLD, or AVOID with stop &amp; target</div></div>
            </div>
            <p>The top picks combine <strong>undervaluation</strong> (low P/E, high ROE), <strong>momentum</strong> (rising price trend), and <strong>real-world catalysts</strong> (earnings beats, analyst upgrades, sector tailwinds) -- verified by AI research. Each card shows a risk range: where to cut losses (Stop) and where to take profit (Target).</p>
            <p>Results update automatically every Monday at 06:00 CET -- or get them straight to your phone.</p>
            <a href="https://t.me/StockScanner1234567890bot" class="tg-cta">Get weekly alerts on Telegram</a>
        </section>

        {# Model Performance #}
        {% if has_history and model_stats %}
        <section class="perf">
            <div class="perf-head">
                <h2>Performance</h2>
                {% if model_stats.timeframes %}
                <div class="tf-pills">
                    {% for tf in model_stats.timeframes %}
                    <button class="tf-pill{% if tf == model_stats.default_timeframe %} on{% endif %}" data-tf="{{ tf }}">{{ tf }}</button>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="perf-nums">
                <div class="perf-n"><div class="perf-nv {% if model_stats.win_rate and model_stats.win_rate >= 50 %}pos{% elif model_stats.win_rate %}neg{% endif %}" id="ps-wr">{{ "%.0f%%"|format(model_stats.win_rate) if model_stats.win_rate is not none else 'N/A' }}</div><div class="perf-nl">Win Rate</div></div>
                <div class="perf-n"><div class="perf-nv">{{ model_stats.total_predictions }}</div><div class="perf-nl">Predictions</div></div>
                <div class="perf-n"><div class="perf-nv" id="ps-ev">{{ model_stats.evaluated }}</div><div class="perf-nl">Evaluated</div></div>
                <div class="perf-n"><div class="perf-nv" id="ps-pe">{{ model_stats.pending }}</div><div class="perf-nl">Pending</div></div>
            </div>

            {% if model_stats.per_signal %}
            {% for sig in ['BUY', 'HOLD', 'AVOID'] %}
            {% set s = model_stats.per_signal.get(sig, {}) %}
            {% if s.total is defined and s.total > 0 %}
            <div class="sig-bar-row">
                <span class="sig-bar-label" style="color:var(--{{ sig|lower }}T)">{{ sig }}</span>
                <div class="sig-bar-bg"><div class="sig-bar-fill {{ sig|lower }}" id="bar-{{ sig|lower }}" style="width:{{ s.accuracy if s.accuracy else 0 }}%"></div></div>
                <span class="sig-bar-pct" id="detail-{{ sig|lower }}">{{ s.correct }}/{{ s.decisive }}{% if s.avg_return is not none %} {{ "%+.1f%%"|format(s.avg_return) }}{% endif %}</span>
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}

            {% if model_stats.performance_timeline and model_stats.performance_timeline|length > 1 %}
            <div class="perf-chart"><canvas id="perfChart"></canvas></div>
            <script>
            (function(){
                var tl={{ model_stats.performance_timeline | tojson }},labels=tl.map(function(s){return s.date}),ds=[],tc={'30d':'#f0883e','60d':'#a371f7','90d':'#3fb950'},tfs={{ model_stats.timeframes | tojson }};
                tfs.forEach(function(tf){ds.push({label:tf+' Win %',data:tl.map(function(s){return s[tf+'_win_rate']}),borderColor:tc[tf]||'#8b949e',backgroundColor:'transparent',fill:false,tension:.3,pointRadius:2,pointHoverRadius:4})});
                ds.push({label:'Avg Return %',data:tl.map(function(s){return s.avg_return}),borderColor:'#58a6ff',fill:false,tension:.3,pointRadius:2,borderDash:[5,3]});
                new Chart(document.getElementById('perfChart'),{type:'line',data:{labels:labels,datasets:ds},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#8b949e',font:{size:10}}},tooltip:{backgroundColor:'#21262d',titleColor:'#e6edf3',bodyColor:'#e6edf3',borderColor:'#30363d',borderWidth:1}},scales:{x:{ticks:{color:'#8b949e',font:{size:9},maxRotation:45},grid:{color:'rgba(48,54,61,0.5)'}},y:{ticks:{color:'#8b949e',font:{size:9}},grid:{color:'rgba(48,54,61,0.5)'}}}}});
            })();
            </script>
            {% elif model_stats.performance_timeline and model_stats.performance_timeline|length == 1 %}
            <div class="perf-chart"><div class="chart-empty">Chart after 2+ scans</div></div>
            {% endif %}

            {% if model_stats.weight_overrides %}
            <details><summary>Weight adjustments</summary><div class="detail-body" style="margin-top:0.5rem">
                {% for factor, base in model_stats.base_weights.items() %}
                {% set o = model_stats.weight_overrides.get(factor, 0) %}
                {% set a = model_stats.active_weights.get(factor, base) %}
                <span class="w-adj {% if o > 0 %}pos{% elif o < 0 %}neg{% else %}zero{% endif %}">{{ factor|capitalize }} {{ a }}{% if o != 0 %} ({{ "%+d"|format(o) }}){% endif %}</span>
                {% endfor %}
            </div></details>
            {% endif %}

            {% if model_stats.recent_evaluations %}
            <details><summary>Recent evaluations</summary><div class="detail-body">
                <table class="eval-tbl"><thead><tr><th>Ticker</th><th>Signal</th><th>Result</th><th>Return</th></tr></thead><tbody>
                {% for e in model_stats.recent_evaluations %}
                <tr><td>{{ e.ticker }}</td><td><span class="signal {{ e.signal|lower }}">{{ e.signal }}</span></td><td class="{% if e.outcome == 'CORRECT' %}oc{% elif e.outcome == 'INCORRECT' %}oi{% else %}ou{% endif %}">{{ e.outcome }}</td><td class="{% if e.return_pct and e.return_pct > 0 %}pos{% elif e.return_pct and e.return_pct < 0 %}neg{% endif %}">{{ "%+.1f%%"|format(e.return_pct) if e.return_pct is not none else '-' }}</td></tr>
                {% endfor %}
                </tbody></table>
            </div></details>
            {% endif %}
        </section>

        {% if model_stats.timeframe_stats %}
        <script>
        (function(){
            var d={{ model_stats.timeframe_stats | tojson }},bs=document.querySelectorAll('.tf-pill');
            if(!bs.length)return;
            function sw(tf){var s=d[tf];if(!s)return;
                var wr=document.getElementById('ps-wr');if(wr){wr.textContent=s.win_rate!==null?Math.round(s.win_rate)+'%':'N/A';wr.className='perf-nv '+(s.win_rate!==null?(s.win_rate>=50?'pos':'neg'):'');}
                var ev=document.getElementById('ps-ev');if(ev)ev.textContent=s.evaluated;
                var pe=document.getElementById('ps-pe');if(pe)pe.textContent=s.pending;
                ['BUY','HOLD','AVOID'].forEach(function(sig){var ps=(s.per_signal||{})[sig]||{};var bar=document.getElementById('bar-'+sig.toLowerCase());var det=document.getElementById('detail-'+sig.toLowerCase());if(bar)bar.style.width=(ps.accuracy||0)+'%';if(det){var t=(ps.correct||0)+'/'+(ps.decisive||0);if(ps.avg_return!==null&&ps.avg_return!==undefined)t+=' '+(ps.avg_return>0?'+':'')+ps.avg_return.toFixed(1)+'%';det.textContent=t;}});
                bs.forEach(function(b){b.classList.toggle('on',b.getAttribute('data-tf')===tf);});
            }
            bs.forEach(function(b){b.addEventListener('click',function(){sw(b.getAttribute('data-tf'));});});
        })();
        </script>
        {% endif %}
        {% endif %}

        {# Cards #}
        <main>
        {% if picks %}
            <div class="controls">
                <button class="fbtn on" data-f="all">All</button>
                <button class="fbtn f-buy on" data-f="buy">BUY</button>
                <button class="fbtn f-hold on" data-f="hold">HOLD</button>
                <button class="fbtn f-avoid on" data-f="avoid">AVOID</button>
                <input type="text" class="search" id="search" placeholder="Search...">
                <select class="sort" id="sort">
                    <option value="sd">Score</option>
                    <option value="sa">Score (low)</option>
                    <option value="az">A-Z</option>
                </select>
            </div>

            <div class="grid" id="grid">
            {% for pick in picks %}
            {% set sc = pick.signal|lower %}
            <div class="card {{ sc }}">
                <div class="card-top">
                    <span class="signal {{ sc }}">{{ pick.signal }}</span>
                    {% if pick.sector %}<span class="card-sector">{{ pick.sector }}</span>{% endif %}
                    <span class="card-score">{{ pick.alpha_score }}</span>
                </div>
                <div style="margin-bottom:0.5rem">
                    <span class="card-ticker">{{ pick.ticker }}</span>
                    <span class="card-name">&mdash; {{ pick.name }}</span>
                    {% if streaks.get(pick.ticker, 0) > 1 %}<span class="streak">{{ streaks[pick.ticker] }}x</span>{% endif %}
                </div>

                {# Visual price range: stop → price → target #}
                {% if pick.stop_loss and pick.take_profit and pick.price %}
                {% set range = pick.take_profit - pick.stop_loss %}
                {% set pos = ((pick.price - pick.stop_loss) / range * 100) if range > 0 else 50 %}
                <div class="range-bar">
                    <div class="range-labels">
                        <span class="range-stop">{{ "%.2f"|format(pick.stop_loss) }}<span class="range-hint">Stop</span></span>
                        <span class="range-price">{{ pick.price }} {{ pick.currency }}<span class="range-hint">Now</span></span>
                        <span class="range-target">{{ "%.2f"|format(pick.take_profit) }}<span class="range-hint">Target</span></span>
                    </div>
                    <div class="range-track">
                        <div class="range-fill" style="width:100%"></div>
                        <div class="range-dot" style="left:{{ pos|round }}%"></div>
                    </div>
                </div>
                {% endif %}

                {% if pick.suggested_pct and pick.suggested_pct > 0 %}
                <span class="alloc">{{ "%.0f"|format(pick.suggested_pct) }}% allocation</span>
                {% endif %}

                {% if pick.reasoning %}
                <div class="reasoning" id="r{{ loop.index }}">{{ pick.reasoning }}</div>
                <button class="read-more" onclick="var r=document.getElementById('r{{ loop.index }}');r.classList.toggle('expanded');this.textContent=r.classList.contains('expanded')?'less':'more'">more</button>
                {% endif %}

                {# Score bar with legend #}
                {% if pick.score_breakdown %}
                {% set bd = pick.score_breakdown %}
                {% set t = pick.alpha_score if pick.alpha_score > 0 else 1 %}
                <div style="margin-top:0.75rem">
                    <div class="score-bar">
                        <div class="sb-val" style="width:{{ (bd.get('value',0)/t*100)|round }}%"></div>
                        <div class="sb-qual" style="width:{{ (bd.get('quality',0)/t*100)|round }}%"></div>
                        <div class="sb-mom" style="width:{{ (bd.get('momentum',0)/t*100)|round }}%"></div>
                        <div class="sb-cat" style="width:{{ (bd.get('catalyst',0)/t*100)|round }}%"></div>
                        <div class="sb-liq" style="width:{{ (bd.get('liquidity',0)/t*100)|round }}%"></div>
                    </div>
                    <div class="score-legend">
                        <span><i style="background:#f0883e"></i>Val {{ bd.get('value',0) }}</span>
                        <span><i style="background:#a371f7"></i>Qual {{ bd.get('quality',0) }}</span>
                        <span><i style="background:#3fb950"></i>Mom {{ bd.get('momentum',0) }}</span>
                        <span><i style="background:#58a6ff"></i>Cat {{ bd.get('catalyst',0) }}</span>
                        <span><i style="background:#d29922"></i>Liq {{ bd.get('liquidity',0) }}</span>
                    </div>
                </div>
                {% endif %}

                <details>
                    <summary>Details</summary>
                    <div class="detail-body">
                        {% if pick.company_overview %}<p>{{ pick.company_overview }}</p>{% endif %}
                        {% if pick.key_developments %}<h4>Developments</h4><ul>{% for d in pick.key_developments[:4] %}<li>{{ d }}</li>{% endfor %}</ul>{% endif %}
                        {% if pick.catalysts %}<h4>Catalysts</h4><ul>{% for c in pick.catalysts[:3] %}<li>{{ c }}</li>{% endfor %}</ul>{% endif %}
                        {% if pick.risk_factors %}<h4>Risks</h4><ul>{% for r in pick.risk_factors[:3] %}<li>{{ r }}</li>{% endfor %}</ul>{% endif %}
                        {% if pick.sources %}<h4>Sources</h4><ul>{% for s in pick.sources[:3] %}<li><a href="{{ s }}" target="_blank" rel="noopener">{{ s[:60] }}{% if s|length > 60 %}...{% endif %}</a></li>{% endfor %}</ul>{% endif %}

                        {# Metrics in details #}
                        <h4>Key Metrics</h4>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.3rem;font-size:0.8rem;margin-top:0.25rem">
                            <div>P/E <strong>{{ "%.1f"|format(pick.pe_ratio) if pick.pe_ratio else '-' }}</strong></div>
                            <div>ROE <strong class="{% if pick.roe and pick.roe > 15 %}pos{% endif %}">{{ "%.0f%%"|format(pick.roe) if pick.roe else '-' }}</strong></div>
                            <div>Div <strong>{{ "%.1f%%"|format(pick.dividend_yield) if pick.dividend_yield else '-' }}</strong></div>
                            <div>6m <strong class="{% if pick.momentum_6m and pick.momentum_6m > 0 %}pos{% elif pick.momentum_6m and pick.momentum_6m < 0 %}neg{% endif %}">{{ "%+.0f%%"|format(pick.momentum_6m) if pick.momentum_6m else '-' }}</strong></div>
                            <div>12m <strong class="{% if pick.momentum_12m and pick.momentum_12m > 0 %}pos{% elif pick.momentum_12m and pick.momentum_12m < 0 %}neg{% endif %}">{{ "%+.0f%%"|format(pick.momentum_12m) if pick.momentum_12m else '-' }}</strong></div>
                            <div>RSI <strong>{{ "%.0f"|format(pick.rsi_14) if pick.rsi_14 else '-' }}</strong></div>
                        </div>
                    </div>
                </details>

                <div class="card-foot">
                    {% set yf = pick.ticker %}
                    {% if pick.exchange == 'AMS' %}{% set yf = pick.ticker ~ '.AS' %}{% elif pick.exchange == 'XETR' %}{% set yf = pick.ticker ~ '.DE' %}{% elif pick.exchange == 'EPA' %}{% set yf = pick.ticker ~ '.PA' %}{% elif pick.exchange == 'LSE' %}{% set yf = pick.ticker ~ '.L' %}{% endif %}
                    <a href="https://finance.yahoo.com/quote/{{ yf }}" target="_blank" rel="noopener">Yahoo Finance &rarr;</a>
                    <span class="tf-badge">{{ pick.target_timeframe if pick.target_timeframe else '3-6 mo' }}</span>
                </div>
            </div>
            {% endfor %}
            </div>
        {% else %}
            <div class="empty">No opportunities found.</div>
        {% endif %}
        </main>

        <footer>
            <p>Data: <a href="https://finance.yahoo.com">Yahoo Finance</a> & <a href="https://twelvedata.com">Twelve Data</a> | AI: <a href="https://perplexity.ai">Perplexity</a></p>
            <p class="disc">Signal generation only. Not financial advice.</p>
        </footer>
    </div>

    <script>
    /* Next scan countdown */
    (function(){var el=document.getElementById('next-scan');if(!el)return;var now=new Date(),next=new Date(now);next.setUTCHours(5,0,0,0);var d=(1-next.getUTCDay()+7)%7;if(d===0&&now>=next)d=7;next.setUTCDate(next.getUTCDate()+d);var diff=next-now;el.textContent='\u00b7 next in '+Math.floor(diff/864e5)+'d '+Math.floor(diff%864e5/36e5)+'h';})();

    /* Tooltip toggle for touch */
    document.addEventListener('click',function(e){var t=e.target.closest('.info-tip');document.querySelectorAll('.info-tip.active').forEach(function(el){if(el!==t)el.classList.remove('active')});if(t){e.preventDefault();t.classList.toggle('active');}});

    /* Filter, sort, search */
    (function(){
        var bs=document.querySelectorAll('.fbtn'),sort=document.getElementById('sort'),search=document.getElementById('search'),grid=document.getElementById('grid');
        if(!bs.length||!sort||!grid)return;
        var af={buy:true,hold:true,avoid:true},st='';
        function sig(c){return c.classList.contains('buy')?'buy':c.classList.contains('hold')?'hold':c.classList.contains('avoid')?'avoid':'';}
        function sc(c){var e=c.querySelector('.card-score');return e?parseInt(e.textContent)||0:0;}
        function tk(c){var e=c.querySelector('.card-ticker');return e?e.textContent.trim():'';}
        function nm(c){var e=c.querySelector('.card-name');return e?e.textContent.toLowerCase():'';}
        function run(){
            var cards=Array.from(grid.querySelectorAll('.card'));
            cards.forEach(function(c){var s=sig(c),t=tk(c).toLowerCase(),n=nm(c);c.style.display=(af[s]&&(!st||t.indexOf(st)!==-1||n.indexOf(st)!==-1))?'':'none';});
            var sv=sort.value;
            cards.sort(function(a,b){return sv==='sa'?sc(a)-sc(b):sv==='az'?tk(a).localeCompare(tk(b)):sc(b)-sc(a);});
            cards.forEach(function(c){grid.appendChild(c);});
        }
        bs.forEach(function(b){b.addEventListener('click',function(){
            var f=b.getAttribute('data-f');
            if(f==='all'){af.buy=af.hold=af.avoid=true;b.classList.add('on');document.querySelectorAll('.fbtn[data-f]:not([data-f="all"])').forEach(function(x){x.classList.add('on')});}
            else{af[f]=!af[f];b.classList.toggle('on',af[f]);var ab=document.querySelector('.fbtn[data-f="all"]');if(ab)ab.classList.toggle('on',af.buy&&af.hold&&af.avoid);}
            run();
        });});
        sort.addEventListener('change',run);
        if(search)search.addEventListener('input',function(){st=search.value.trim().toLowerCase();run();});
    })();
    </script>
</body>
</html>
