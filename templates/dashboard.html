<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Alpha Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --buy: #238636;
            --buy-text: #3fb950;
            --hold: #1f6feb;
            --hold-text: #58a6ff;
            --avoid: #da3633;
            --avoid-text: #f85149;
            --link-color: #58a6ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 2.5rem;
            margin-top: 1rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--link-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Controls bar */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.35rem 0.9rem;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, background 0.2s, color 0.2s, border-color 0.2s;
            opacity: 0.5;
        }

        .filter-btn.active {
            opacity: 1;
        }

        .filter-btn[data-filter="all"].active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .filter-btn.filter-buy.active {
            background: rgba(35, 134, 54, 0.2);
            color: var(--buy-text);
            border-color: var(--buy);
        }

        .filter-btn.filter-hold.active {
            background: rgba(31, 111, 235, 0.2);
            color: var(--hold-text);
            border-color: var(--hold);
        }

        .filter-btn.filter-avoid.active {
            background: rgba(218, 54, 51, 0.2);
            color: var(--avoid-text);
            border-color: var(--avoid);
        }

        .sort-control {
            flex-shrink: 0;
        }

        .sort-select {
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--link-color);
        }

        /* Stock cards */
        .pick-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .pick-card:hover {
            border-color: var(--text-secondary);
        }

        .pick-card.buy {
            border-left: 4px solid var(--buy);
        }

        .pick-card.hold {
            border-left: 4px solid var(--hold);
        }

        .pick-card.avoid {
            border-left: 4px solid var(--avoid);
        }

        .pick-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .signal-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-badge.buy {
            background: rgba(35, 134, 54, 0.2);
            color: var(--buy-text);
        }

        .signal-badge.hold {
            background: rgba(31, 111, 235, 0.2);
            color: var(--hold-text);
        }

        .signal-badge.avoid {
            background: rgba(218, 54, 51, 0.2);
            color: var(--avoid-text);
        }

        .alpha-score {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .sector-tag {
            padding: 0.15rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .stock-title {
            font-size: 1.15rem;
            margin-bottom: 0.5rem;
        }

        .stock-title .ticker {
            font-weight: 700;
            color: var(--text-primary);
        }

        .stock-title .name {
            color: var(--text-secondary);
            font-weight: 400;
        }

        .streak-badge {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            background: rgba(210, 153, 34, 0.2);
            color: #d29922;
            vertical-align: middle;
            margin-left: 0.4rem;
        }

        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .metric-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .positive { color: var(--buy-text); }
        .negative { color: var(--avoid-text); }
        .neutral { color: var(--text-primary); }

        /* Score breakdown bar */
        .score-bar {
            display: flex;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
            background: var(--bg-tertiary);
        }

        .score-segment {
            height: 100%;
            transition: width 0.3s;
        }

        .score-segment.value { background: #f0883e; }
        .score-segment.quality { background: #a371f7; }
        .score-segment.momentum { background: #3fb950; }
        .score-segment.catalyst { background: #58a6ff; }
        .score-segment.liquidity { background: #d29922; }

        .score-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .score-legend span::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            margin-right: 4px;
            vertical-align: middle;
        }

        .score-legend .l-value::before { background: #f0883e; }
        .score-legend .l-quality::before { background: #a371f7; }
        .score-legend .l-momentum::before { background: #3fb950; }
        .score-legend .l-catalyst::before { background: #58a6ff; }
        .score-legend .l-liquidity::before { background: #d29922; }

        /* Reasoning */
        .reasoning {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.95rem;
        }

        /* Expandable details */
        details {
            margin-bottom: 0.75rem;
        }

        summary {
            cursor: pointer;
            color: var(--link-color);
            font-size: 0.9rem;
        }

        summary:hover {
            text-decoration: underline;
        }

        .detail-content {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .detail-content h4 {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .detail-content ul {
            list-style: none;
            margin-bottom: 1rem;
        }

        .detail-content li {
            padding: 0.25rem 0;
            font-size: 0.9rem;
            padding-left: 1rem;
            position: relative;
        }

        .detail-content li::before {
            content: "\2022";
            position: absolute;
            left: 0;
            color: var(--text-secondary);
        }

        .detail-content a {
            color: var(--link-color);
            text-decoration: none;
            word-break: break-all;
        }

        .detail-content a:hover {
            text-decoration: underline;
        }

        /* Card footer */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .yahoo-link {
            color: var(--link-color);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .yahoo-link:hover {
            text-decoration: underline;
        }

        .timeframe-badge {
            padding: 0.15rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Model Performance */
        .model-performance {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .model-performance h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .perf-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

        .perf-stat {
            text-align: center;
        }

        .perf-stat-value {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .perf-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .signal-accuracy {
            margin-bottom: 1rem;
        }

        .signal-accuracy-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .signal-accuracy-label {
            width: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .accuracy-bar-bg {
            flex: 1;
            height: 10px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            overflow: hidden;
        }

        .accuracy-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s;
        }

        .accuracy-bar-fill.buy { background: var(--buy); }
        .accuracy-bar-fill.hold { background: var(--hold); }
        .accuracy-bar-fill.avoid { background: var(--avoid); }

        .accuracy-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
            width: 140px;
            text-align: right;
        }

        .eval-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .eval-table th {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .eval-table td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .outcome-correct { color: var(--buy-text); }
        .outcome-incorrect { color: var(--avoid-text); }
        .outcome-inconclusive { color: var(--text-secondary); }

        .weight-adj {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .weight-adj.positive {
            background: rgba(35, 134, 54, 0.2);
            color: var(--buy-text);
        }

        .weight-adj.negative {
            background: rgba(218, 54, 51, 0.2);
            color: var(--avoid-text);
        }

        .weight-adj.zero {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        /* Performance chart */
        .perf-chart-container {
            position: relative;
            height: 220px;
            margin-bottom: 1.25rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .perf-chart-container canvas {
            width: 100% !important;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Empty state */
        .no-picks {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        /* Footer */
        footer {
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        footer a {
            color: var(--link-color);
            text-decoration: none;
        }

        .disclaimer {
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Info tooltips */
        .info-tip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.55rem;
            font-weight: 700;
            font-style: normal;
            cursor: help;
            vertical-align: middle;
            margin-left: 4px;
            flex-shrink: 0;
        }

        .info-tip:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .info-tip .tip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.75rem;
            font-weight: 400;
            line-height: 1.4;
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            width: 240px;
            z-index: 100;
            transition: opacity 0.15s, visibility 0.15s;
            pointer-events: none;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .info-tip .tip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border-color);
        }

        .info-tip:hover .tip-text {
            visibility: visible;
            opacity: 1;
        }

        .info-tip.active .tip-text {
            visibility: visible;
            opacity: 1;
            transition: none;
        }

        /* Flip tooltip down when near top */
        .info-tip.tip-down .tip-text {
            bottom: auto;
            top: calc(100% + 8px);
        }

        .info-tip.tip-down .tip-text::after {
            top: auto;
            bottom: 100%;
            border-top-color: transparent;
            border-bottom-color: var(--border-color);
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .stats {
                gap: 1rem;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .controls-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-buttons {
                width: 100%;
            }

            .filter-btn {
                font-size: 0.75rem;
                padding: 0.3rem 0.7rem;
            }

            .sort-select {
                width: 100%;
                font-size: 0.75rem;
            }

            .sort-control {
                width: 100%;
            }

            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            /* Model Performance mobile */
            .model-performance {
                padding: 1rem;
            }

            .model-performance h2 {
                font-size: 1.05rem;
            }

            .perf-stats {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .perf-stat-value {
                font-size: 1.15rem;
            }

            .signal-accuracy-row {
                flex-wrap: wrap;
                gap: 0.25rem;
            }

            .signal-accuracy-label {
                width: 45px;
                font-size: 0.8rem;
            }

            .accuracy-bar-bg {
                min-width: 0;
            }

            .accuracy-detail {
                width: 100%;
                text-align: left;
                padding-left: 45px;
                font-size: 0.7rem;
            }

            .perf-chart-container {
                height: 180px;
            }

            .eval-table {
                font-size: 0.75rem;
            }

            .eval-table th,
            .eval-table td {
                padding: 0.35rem 0.25rem;
            }

            .eval-table .signal-badge {
                font-size: 0.65rem;
                padding: 0.15rem 0.4rem;
            }

            .weight-adj {
                font-size: 0.7rem;
                padding: 0.1rem 0.4rem;
            }

            /* Tooltips: always flip down on mobile, shrink width */
            .info-tip .tip-text {
                bottom: auto;
                top: calc(100% + 8px);
                width: 200px;
            }

            .info-tip .tip-text::after {
                top: auto;
                bottom: 100%;
                border-top-color: transparent;
                border-bottom-color: var(--border-color);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Stock Alpha Scanner</h1>
            <p class="meta">
                Last updated: {{ run_date[:19].replace('T', ' ') }} UTC
            </p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value">{{ stocks_scanned }}</div>
                    <div class="stat-label">Stocks Scanned</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: var(--buy-text);">{{ buy_count }}</div>
                    <div class="stat-label">BUY</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: var(--hold-text);">{{ hold_count }}</div>
                    <div class="stat-label">HOLD</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: var(--avoid-text);">{{ avoid_count }}</div>
                    <div class="stat-label">AVOID</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{{ avg_score }}</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            </div>
        </header>

        {% if has_history and model_stats %}
        <section class="model-performance">
            <h2>Model Performance <span class="info-tip tip-down">i<span class="tip-text">Tracks how well the scanner's past predictions performed. Predictions are evaluated after 90+ days by comparing the price at signal time to the current price.</span></span></h2>

            <div class="perf-stats">
                <div class="perf-stat">
                    <div class="perf-stat-value {% if model_stats.win_rate and model_stats.win_rate >= 50 %}positive{% elif model_stats.win_rate %}negative{% else %}neutral{% endif %}">
                        {{ "%.0f%%"|format(model_stats.win_rate) if model_stats.win_rate is not none else 'N/A' }}
                    </div>
                    <div class="perf-stat-label">Win Rate</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-stat-value neutral">{{ model_stats.total_predictions }}</div>
                    <div class="perf-stat-label">Total Predictions</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-stat-value neutral">{{ model_stats.evaluated }}</div>
                    <div class="perf-stat-label">Evaluated</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-stat-value neutral">{{ model_stats.pending }}</div>
                    <div class="perf-stat-label">Pending</div>
                </div>
            </div>

            {% if model_stats.per_signal %}
            <div class="signal-accuracy">
                {% for signal in ['BUY', 'HOLD', 'AVOID'] %}
                {% set s = model_stats.per_signal.get(signal, {}) %}
                {% if s.total is defined and s.total > 0 %}
                <div class="signal-accuracy-row">
                    <span class="signal-accuracy-label" style="color: var(--{{ signal|lower }}-text);">{{ signal }}</span>
                    <div class="accuracy-bar-bg">
                        <div class="accuracy-bar-fill {{ signal|lower }}" style="width: {{ s.accuracy if s.accuracy else 0 }}%"></div>
                    </div>
                    <span class="accuracy-detail">
                        {{ s.correct }}/{{ s.decisive }} correct
                        {% if s.avg_return is not none %} | {{ "%+.1f%%"|format(s.avg_return) }} avg{% endif %}
                    </span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            {% if model_stats.performance_timeline and model_stats.performance_timeline|length > 1 %}
            <div class="perf-chart-container">
                <canvas id="perfChart"></canvas>
            </div>
            <script>
            (function() {
                const timeline = {{ model_stats.performance_timeline | tojson }};
                const labels = timeline.map(s => s.date);
                const winRates = timeline.map(s => s.win_rate);
                const avgReturns = timeline.map(s => s.avg_return);
                const evaluated = timeline.map(s => s.evaluated);

                const ctx = document.getElementById('perfChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Win Rate %',
                                data: winRates,
                                borderColor: '#3fb950',
                                backgroundColor: 'rgba(63,185,80,0.1)',
                                fill: true,
                                tension: 0.3,
                                yAxisID: 'y',
                                pointRadius: 3,
                                pointHoverRadius: 5,
                            },
                            {
                                label: 'Avg Return %',
                                data: avgReturns,
                                borderColor: '#58a6ff',
                                backgroundColor: 'rgba(88,166,255,0.1)',
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y',
                                pointRadius: 3,
                                pointHoverRadius: 5,
                                borderDash: [5, 3],
                            },
                            {
                                label: 'Evaluated',
                                data: evaluated,
                                borderColor: '#8b949e',
                                backgroundColor: 'rgba(139,148,158,0.15)',
                                fill: true,
                                tension: 0.3,
                                yAxisID: 'y1',
                                pointRadius: 2,
                                pointHoverRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: {
                                labels: { color: '#8b949e', font: { size: 11 } }
                            },
                            tooltip: {
                                backgroundColor: '#21262d',
                                titleColor: '#e6edf3',
                                bodyColor: '#e6edf3',
                                borderColor: '#30363d',
                                borderWidth: 1,
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#8b949e', font: { size: 10 }, maxRotation: 45 },
                                grid: { color: 'rgba(48,54,61,0.5)' }
                            },
                            y: {
                                position: 'left',
                                title: { display: true, text: '%', color: '#8b949e' },
                                ticks: { color: '#8b949e', font: { size: 10 } },
                                grid: { color: 'rgba(48,54,61,0.5)' }
                            },
                            y1: {
                                position: 'right',
                                title: { display: true, text: 'Count', color: '#8b949e' },
                                ticks: { color: '#8b949e', font: { size: 10 } },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            })();
            </script>
            {% elif model_stats.performance_timeline and model_stats.performance_timeline|length == 1 %}
            <div class="perf-chart-container">
                <div class="chart-placeholder">Performance chart will appear after the second scan with history.</div>
            </div>
            {% endif %}

            {% if model_stats.weight_overrides %}
            <details>
                <summary>Adaptive Weight Adjustments</summary>
                <div class="detail-content">
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                        Weights are automatically adjusted based on which factors best predicted actual returns.
                    </p>
                    {% for factor, base in model_stats.base_weights.items() %}
                    {% set override = model_stats.weight_overrides.get(factor, 0) %}
                    {% set active = model_stats.active_weights.get(factor, base) %}
                    <span class="weight-adj {% if override > 0 %}positive{% elif override < 0 %}negative{% else %}zero{% endif %}">
                        {{ factor|capitalize }}: {{ active }} {% if override != 0 %}({{ "%+d"|format(override) }}){% endif %}
                    </span>
                    {% endfor %}
                </div>
            </details>
            {% endif %}

            {% if model_stats.recent_evaluations %}
            <details>
                <summary>Recent Evaluations</summary>
                <div class="detail-content">
                    <table class="eval-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Signal</th>
                                <th>Outcome</th>
                                <th>Return</th>
                                <th>Scan Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in model_stats.recent_evaluations %}
                            <tr>
                                <td>{{ e.ticker }}</td>
                                <td><span class="signal-badge {{ e.signal|lower }}">{{ e.signal }}</span></td>
                                <td class="outcome-{{ e.outcome|lower }}">{{ e.outcome }}</td>
                                <td class="{% if e.return_pct and e.return_pct > 0 %}positive{% elif e.return_pct and e.return_pct < 0 %}negative{% else %}neutral{% endif %}">
                                    {{ "%+.1f%%"|format(e.return_pct) if e.return_pct is not none else 'N/A' }}
                                </td>
                                <td style="color: var(--text-secondary);">{{ e.scan_date }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
            {% endif %}
        </section>
        {% endif %}

        <main>
            {% if picks %}
                <div class="controls-bar">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn filter-buy active" data-filter="buy">BUY</button>
                        <button class="filter-btn filter-hold active" data-filter="hold">HOLD</button>
                        <button class="filter-btn filter-avoid active" data-filter="avoid">AVOID</button>
                    </div>
                    <div class="sort-control">
                        <select id="sort-select" class="sort-select">
                            <option value="score-desc">Score (high-low)</option>
                            <option value="score-asc">Score (low-high)</option>
                            <option value="ticker-az">Ticker A-Z</option>
                        </select>
                    </div>
                </div>

                {% for pick in picks %}
                {% set signal_class = pick.signal|lower %}
                <div class="pick-card {{ signal_class }}">
                    <div class="pick-header">
                        <div class="header-left">
                            <span class="signal-badge {{ signal_class }}">{{ pick.signal }}</span>
                            <span class="info-tip tip-down">i<span class="tip-text">{% if pick.signal == 'BUY' %}BUY: AI research is bullish with high confidence and the stock scores well on fundamentals, momentum, and quality.{% elif pick.signal == 'HOLD' %}HOLD: AI research found a neutral outlook, or the bullish case wasn't strong enough to warrant a BUY. The stock may still score well on fundamentals -- worth monitoring.{% else %}AVOID: AI research is bearish with medium-high confidence. Significant risks or negative outlook detected.{% endif %}</span></span>
                            <span class="alpha-score">Score: {{ pick.alpha_score }}<span class="info-tip tip-down">i<span class="tip-text">Alpha Score (0-100): Composite score based on 5 factors -- Value (25pts), Quality (25pts), Momentum (25pts), Catalyst (15pts), and Liquidity (10pts). Higher = stronger opportunity.</span></span></span>
                            {% if pick.sector %}
                            <span class="sector-tag">{{ pick.sector }}</span>
                            {% endif %}
                        </div>
                        <span class="alpha-score">{{ pick.confidence }} confidence<span class="info-tip tip-down">i<span class="tip-text">{% if pick.confidence == 'HIGH' %}HIGH: AI research is very certain about its assessment. Note: high confidence in a NEUTRAL outlook still results in HOLD.{% elif pick.confidence == 'MEDIUM' %}MEDIUM: AI research found supporting evidence but with some uncertainty or conflicting signals.{% else %}LOW: Limited evidence available or significant uncertainty in the outlook.{% endif %}</span></span></span>
                    </div>

                    <h3 class="stock-title">
                        <span class="ticker">{{ pick.ticker }}</span>
                        <span class="name"> &mdash; {{ pick.name }}</span>
                        {% if streaks.get(pick.ticker, 0) > 1 %}
                        <span class="streak-badge">{{ streaks[pick.ticker] }}x streak</span>
                        {% endif %}
                    </h3>

                    <!-- Metrics grid -->
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-value neutral">{{ "%.1f"|format(pick.pe_ratio) if pick.pe_ratio else 'N/A' }}</div>
                            <div class="metric-label">P/E <span class="info-tip">i<span class="tip-text">Price-to-Earnings ratio. Compares stock price to earnings per share. Lower = cheaper relative to profits. Compare within the same sector.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.roe and pick.roe > 15 %}positive{% elif pick.roe and pick.roe < 5 %}negative{% else %}neutral{% endif %}">
                                {{ "%.1f%%"|format(pick.roe) if pick.roe else 'N/A' }}
                            </div>
                            <div class="metric-label">ROE <span class="info-tip">i<span class="tip-text">Return on Equity. How efficiently the company generates profit from shareholder money. Above 15% is strong, above 20% is excellent.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.dividend_yield and pick.dividend_yield > 2 %}positive{% else %}neutral{% endif %}">
                                {{ "%.1f%%"|format(pick.dividend_yield) if pick.dividend_yield else 'N/A' }}
                            </div>
                            <div class="metric-label">Div Yield <span class="info-tip">i<span class="tip-text">Annual dividend as % of stock price. Above 2% is solid, above 3% is high yield. 0% means the company doesn't pay dividends.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.momentum_6m and pick.momentum_6m > 0 %}positive{% elif pick.momentum_6m and pick.momentum_6m < 0 %}negative{% else %}neutral{% endif %}">
                                {{ "%+.1f%%"|format(pick.momentum_6m) if pick.momentum_6m else 'N/A' }}
                            </div>
                            <div class="metric-label">6m <span class="info-tip">i<span class="tip-text">Price return over the last 6 months. Green = stock has been rising, red = declining. Shows medium-term trend.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.momentum_12m and pick.momentum_12m > 0 %}positive{% elif pick.momentum_12m and pick.momentum_12m < 0 %}negative{% else %}neutral{% endif %}">
                                {{ "%+.1f%%"|format(pick.momentum_12m) if pick.momentum_12m else 'N/A' }}
                            </div>
                            <div class="metric-label">12m <span class="info-tip">i<span class="tip-text">Price return over the last 12 months. Shows the longer-term trend. Stocks with positive 12m momentum tend to continue performing.</span></span></div>
                        </div>
                        <div class="metric">
                            <div class="metric-value {% if pick.rsi_14 and pick.rsi_14 > 70 %}negative{% elif pick.rsi_14 and pick.rsi_14 < 30 %}positive{% else %}neutral{% endif %}">
                                {{ "%.0f"|format(pick.rsi_14) if pick.rsi_14 else 'N/A' }}
                            </div>
                            <div class="metric-label">RSI <span class="info-tip">i<span class="tip-text">Relative Strength Index (0-100). Below 30 = oversold (potential bounce), above 70 = overbought (potential pullback), 40-70 = healthy range.</span></span></div>
                        </div>
                    </div>

                    <!-- Score breakdown bar -->
                    {% if pick.score_breakdown %}
                    {% set bd = pick.score_breakdown %}
                    {% set total = pick.alpha_score if pick.alpha_score > 0 else 1 %}
                    <div class="score-bar">
                        <div class="score-segment value" style="width: {{ (bd.get('value', 0) / total * 100)|round }}%"></div>
                        <div class="score-segment quality" style="width: {{ (bd.get('quality', 0) / total * 100)|round }}%"></div>
                        <div class="score-segment momentum" style="width: {{ (bd.get('momentum', 0) / total * 100)|round }}%"></div>
                        <div class="score-segment catalyst" style="width: {{ (bd.get('catalyst', 0) / total * 100)|round }}%"></div>
                        <div class="score-segment liquidity" style="width: {{ (bd.get('liquidity', 0) / total * 100)|round }}%"></div>
                    </div>
                    <div class="score-legend">
                        <span class="l-value">Value {{ bd.get('value', 0) }}/25 <span class="info-tip">i<span class="tip-text">Value: Is the stock cheap? Based on P/E and P/B vs sector median, plus dividend yield.</span></span></span>
                        <span class="l-quality">Quality {{ bd.get('quality', 0) }}/25 <span class="info-tip">i<span class="tip-text">Quality: Is it a good business? Based on ROE, low debt, dividend track record, and earnings growth.</span></span></span>
                        <span class="l-momentum">Momentum {{ bd.get('momentum', 0) }}/25 <span class="info-tip">i<span class="tip-text">Momentum: Is it trending up? Based on 6m/12m returns, price vs moving averages, and RSI health.</span></span></span>
                        <span class="l-catalyst">Catalyst {{ bd.get('catalyst', 0) }}/15 <span class="info-tip">i<span class="tip-text">Catalyst: Are there upcoming events? Scores for earnings dates, priority sectors, and recovery potential from 52-week highs.</span></span></span>
                        <span class="l-liquidity">Liquidity {{ bd.get('liquidity', 0) }}/10 <span class="info-tip">i<span class="tip-text">Liquidity: Can you trade it easily? Based on market cap size, trading volume, and major index membership.</span></span></span>
                    </div>
                    {% endif %}

                    <!-- Reasoning -->
                    {% if pick.reasoning %}
                    <div class="reasoning">{{ pick.reasoning }}</div>
                    {% endif %}

                    <!-- Expandable details -->
                    <details>
                        <summary>Developments, Catalysts & Risks</summary>
                        <div class="detail-content">
                            {% if pick.company_overview %}
                            <h4>Overview</h4>
                            <p style="margin-bottom: 1rem; font-size: 0.9rem;">{{ pick.company_overview }}</p>
                            {% endif %}

                            {% if pick.key_developments %}
                            <h4>Key Developments</h4>
                            <ul>
                                {% for dev in pick.key_developments[:5] %}
                                <li>{{ dev }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if pick.catalysts %}
                            <h4>Catalysts</h4>
                            <ul>
                                {% for cat in pick.catalysts[:4] %}
                                <li>{{ cat }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if pick.risk_factors %}
                            <h4>Risk Factors</h4>
                            <ul>
                                {% for risk in pick.risk_factors[:4] %}
                                <li>{{ risk }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if pick.sources %}
                            <h4>Sources</h4>
                            <ul>
                                {% for src in pick.sources[:5] %}
                                <li><a href="{{ src }}" target="_blank" rel="noopener">{{ src[:70] }}{% if src|length > 70 %}...{% endif %}</a></li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                    </details>

                    <div class="card-footer">
                        {% set yf_symbol = pick.ticker %}
                        {% if pick.exchange == 'AMS' %}{% set yf_symbol = pick.ticker ~ '.AS' %}
                        {% elif pick.exchange == 'XETR' %}{% set yf_symbol = pick.ticker ~ '.DE' %}
                        {% elif pick.exchange == 'EPA' %}{% set yf_symbol = pick.ticker ~ '.PA' %}
                        {% elif pick.exchange == 'LSE' %}{% set yf_symbol = pick.ticker ~ '.L' %}
                        {% endif %}
                        <a href="https://finance.yahoo.com/quote/{{ yf_symbol }}" class="yahoo-link" target="_blank" rel="noopener">
                            View on Yahoo Finance &rarr;
                        </a>
                        <span class="timeframe-badge">{{ pick.target_timeframe if pick.target_timeframe else '3-6 months' }} <span class="info-tip">i<span class="tip-text">Suggested investment horizon. This signal is based on medium-term analysis -- not a day-trading recommendation.</span></span></span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-picks">
                    No high-alpha opportunities found in this scan.
                </div>
            {% endif %}
        </main>

        <footer>
            <p>
                Data from <a href="https://finance.yahoo.com" target="_blank">Yahoo Finance</a>
                & <a href="https://twelvedata.com" target="_blank">Twelve Data</a>
                | Research via <a href="https://perplexity.ai" target="_blank">Perplexity</a>
            </p>
            <p class="disclaimer">
                Signal generation only. Not financial advice. Do your own research.
            </p>
        </footer>
    </div>
    <script>
    /* Toggle tooltips on tap for touch devices */
    document.addEventListener('click', function(e) {
        var tip = e.target.closest('.info-tip');
        document.querySelectorAll('.info-tip.active').forEach(function(el) {
            if (el !== tip) el.classList.remove('active');
        });
        if (tip) {
            e.preventDefault();
            tip.classList.toggle('active');
        }
    });

    /* Filter and sort controls */
    (function() {
        var filterBtns = document.querySelectorAll('.filter-btn');
        var sortSelect = document.getElementById('sort-select');
        if (!filterBtns.length || !sortSelect) return;

        /* Track which signal types are visible */
        var activeFilters = { buy: true, hold: true, avoid: true };

        function getCardSignal(card) {
            if (card.classList.contains('buy')) return 'buy';
            if (card.classList.contains('hold')) return 'hold';
            if (card.classList.contains('avoid')) return 'avoid';
            return '';
        }

        function getCardScore(card) {
            var el = card.querySelector('.alpha-score');
            if (!el) return 0;
            var m = el.textContent.match(/Score:\s*(\d+)/);
            return m ? parseInt(m[1], 10) : 0;
        }

        function getCardTicker(card) {
            var el = card.querySelector('.ticker');
            return el ? el.textContent.trim() : '';
        }

        function applyFilterAndSort() {
            var container = document.querySelector('main');
            if (!container) return;
            var cards = Array.from(container.querySelectorAll('.pick-card'));

            /* Apply filters -- show/hide */
            cards.forEach(function(card) {
                var signal = getCardSignal(card);
                card.style.display = activeFilters[signal] ? '' : 'none';
            });

            /* Sort only visible cards */
            var sortVal = sortSelect.value;
            cards.sort(function(a, b) {
                if (sortVal === 'score-desc') {
                    return getCardScore(b) - getCardScore(a);
                } else if (sortVal === 'score-asc') {
                    return getCardScore(a) - getCardScore(b);
                } else {
                    return getCardTicker(a).localeCompare(getCardTicker(b));
                }
            });

            /* Re-append in sorted order */
            cards.forEach(function(card) {
                container.appendChild(card);
            });
        }

        function updateAllButton() {
            var allBtn = document.querySelector('.filter-btn[data-filter="all"]');
            if (!allBtn) return;
            var allActive = activeFilters.buy && activeFilters.hold && activeFilters.avoid;
            allBtn.classList.toggle('active', allActive);
        }

        filterBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var filter = btn.getAttribute('data-filter');

                if (filter === 'all') {
                    /* Toggle all on */
                    activeFilters.buy = true;
                    activeFilters.hold = true;
                    activeFilters.avoid = true;
                    btn.classList.add('active');
                    document.querySelectorAll('.filter-btn[data-filter!="all"]').forEach(function(b) {
                        b.classList.add('active');
                    });
                } else {
                    /* Toggle individual filter */
                    activeFilters[filter] = !activeFilters[filter];
                    btn.classList.toggle('active', activeFilters[filter]);
                    updateAllButton();
                }

                applyFilterAndSort();
            });
        });

        sortSelect.addEventListener('change', function() {
            applyFilterAndSort();
        });
    })();
    </script>
</body>
</html>
